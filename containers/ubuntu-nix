# -*- mode:dockerfile -*-
FROM ubuntu:latest

# Prevent interactive prompts during install
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update

# Install systemd
RUN apt-get install systemd -y
RUN apt-get install -y locales && \
    locale-gen en_US.UTF-8
RUN echo "LANG=en_US.UTF-8" > /etc/locale.conf

# Install sudo and create user
RUN apt-get install -y sudo \
    && useradd -ms /bin/bash sisyphus \
    && echo "sisyphus:password" | chpasswd \
    && usermod -aG sudo sisyphus \
    && echo "sisyphus ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install Nix
RUN apt-get install curl -y
RUN curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux \
    --extra-conf "sandbox = false" \
    --no-start-daemon \
    --no-confirm
ENV PATH="${PATH}:/nix/var/nix/profiles/default/bin"

# Install devenv.sh
RUN nix-env --install --attr devenv -f https://github.com/NixOS/nixpkgs/tarball/nixpkgs-unstable

# Install utility packages
RUN apt-get install -y \
    git tmux

# Install github cli
RUN (type -p wget >/dev/null || (apt update && apt-get install wget -y)) \
    && mkdir -p -m 755 /etc/apt/keyrings \
    && out=$(mktemp) && wget -nv -O$out https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    && cat $out | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
    && chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt update \
    && apt install gh -y

CMD [ "/bin/systemd" ]
